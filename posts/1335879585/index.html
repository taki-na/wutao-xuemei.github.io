<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>从 GFW 原理到翻墙原理和协议 | 躺平的blog</title><meta name="keywords" content="GFW,VPN,互联网"><meta name="author" content="吴涛"><meta name="copyright" content="吴涛"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="GFW 的原理 要与 GFW 对抗不能仅仅停留在什么不能访问了，什么可以访问之类的表面现象上。知道 youtube 不能访问了，对于翻墙来说并无帮助。但是知道 GFW 是如何让我们不能访问 youtube 的，则对下一步的翻墙方案的选择和实施具有重大意义。所以在讨论如何翻之前，先要深入原理了解 GFW 是如何封的。 总的来说，GFW 是一个分布式的入侵检测系统，并不是一个严格意义上的防火墙。不是">
<meta property="og:type" content="article">
<meta property="og:title" content="从 GFW 原理到翻墙原理和协议">
<meta property="og:url" content="https://blog.laozheng.cf/posts/1335879585/index.html">
<meta property="og:site_name" content="躺平的blog">
<meta property="og:description" content="GFW 的原理 要与 GFW 对抗不能仅仅停留在什么不能访问了，什么可以访问之类的表面现象上。知道 youtube 不能访问了，对于翻墙来说并无帮助。但是知道 GFW 是如何让我们不能访问 youtube 的，则对下一步的翻墙方案的选择和实施具有重大意义。所以在讨论如何翻之前，先要深入原理了解 GFW 是如何封的。 总的来说，GFW 是一个分布式的入侵检测系统，并不是一个严格意义上的防火墙。不是">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.laozheng.cf/img/gfw_bg.webp">
<meta property="article:published_time" content="2022-08-29T07:55:40.000Z">
<meta property="article:modified_time" content="2022-08-29T09:21:26.656Z">
<meta property="article:author" content="吴涛">
<meta property="article:tag" content="GFW">
<meta property="article:tag" content="VPN">
<meta property="article:tag" content="互联网">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.laozheng.cf/img/gfw_bg.webp"><link rel="shortcut icon" href="/img/81214117_p1.webp"><link rel="canonical" href="https://blog.laozheng.cf/posts/1335879585/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//static.cloudflareinsights.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script defer="defer" data-pjax="data-pjax" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;b3430d59ffa54324ac9fc5b375014017&quot;}"></script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":180,"position":"top","messagePrev":"距离上次更新已经过了","messageNext":"天，文章所描述的内容可能已经发生变化，请留意。"},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '从 GFW 原理到翻墙原理和协议',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-08-29 17:21:26'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/mycss.css"><meta name="generator" content="Hexo 6.2.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "/img/friend_404.gif" data-lazy-src="/img/81214117_p1.webp" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">14</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/gfw_bg.webp')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">躺平的blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">从 GFW 原理到翻墙原理和协议</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-08-29T07:55:40.000Z" title="发表于 2022-08-29 15:55:40">2022-08-29</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-08-29T09:21:26.656Z" title="更新于 2022-08-29 17:21:26">2022-08-29</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/GFW/">GFW</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">7.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>24分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="从 GFW 原理到翻墙原理和协议"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="gfw-的原理"><a class="markdownIt-Anchor" href="#gfw-的原理"></a> GFW 的原理</h2>
<p>要与 GFW 对抗不能仅仅停留在什么不能访问了，什么可以访问之类的表面现象上。知道 youtube 不能访问了，对于翻墙来说并无帮助。但是知道 GFW 是如何让我们不能访问 youtube 的，则对下一步的翻墙方案的选择和实施具有重大意义。所以在讨论如何翻之前，先要深入原理了解 GFW 是如何封的。</p>
<p>总的来说，GFW 是一个分布式的入侵检测系统，并不是一个严格意义上的防火墙。不是说每个出入国境的 IP 包都需要先经过 GFW 的首可。做为一个入侵检测系统，GFW 把你每一次访问 facebook 都看做一次入侵，然后在检测到入侵之后采取应对措施，也就是常见的连接重置。</p>
<p>检测有两种方式。一种是人工检测，一种是机器检测。你去国新办网站举报，就是参与了人工检测。在人工检测到不和谐的网站之后，就会采取一些应对方式来防止国内的网民访问该网站。对于这类的封锁，规避检测就不是技术问题了，只能从 GFW 采取的应对方式上采取反制措施。另外一类检测是机器检测，其检测过程又可以再进一步细分：</p>
<p><img src= "/img/friend_404.gif" data-lazy-src="/img/gfw.png" alt="" /></p>
<p>重建是指 GFW 从网络上监听过往的 IP 包，然后分析其中的 TCP 协议，最后重建出一个完整的字节流。分析是在这个重建的字节流上分析具体的应用协议，比如 HTTP 协议。然后在应用协议中查找是不是有不和谐的内容，然后决定采用何种应对方式。</p>
<p>所以，GFW 机器检测的第一步就是重建出一个字节流。那么 GFW 是如何拿到原始的 IP 包的呢？真正的 GFW 部署方式，外人根本无从得知。据猜测，GFW 是部署在国家的出口路由器的旁路上，用 “分光” 的方式把 IP 包复制一份到另外一根光纤上，从而拿到所有进出国境的 IP 包。下图引在 <a target="_blank" rel="noopener" href="http://gfwrev.blogspot.com">gfwrev.blogspot.com</a>：</p>
<p><img src= "/img/friend_404.gif" data-lazy-src="/img/gfw1.png" alt="" /></p>
<p>但是 Google 在北京有自己的机房。所以聪明的网友就使用 Google 的北京机房提供的 GAE 服务，用 Goagent 软件达到高速翻墙的目的。但是有网友<a target="_blank" rel="noopener" href="https://twitter.com/chengr28/status/260970749190365184">证实</a>(链接已失效)，即便是北京的机房也会被骨干网丢包。事实上 Google 在北京的谷翔机房有一个独立的 AS（BGP 的概念）。这个 AS 与谷歌总部有一条 IPV6 的直连线路，所以通过这个机房可以用 IPV6 不受墙的限制出去。但是这个 AS 无论是连接国内还是国外都是要经过 GFW 的。所以机房在北京也不能保证国内访问不被墙。GFW 通过配置骨干网的 BGP 路由规则，是可以让国内的机房也经过它的。另外一个例子是当我们访问被封的网站触发连接重置的时候，往往收到两个 RST 包，但是 TTL 不同。还有一个例子是对于被封的 IP，访问的 IP 包还没有到达国际出口就已经被丢弃。所以 GFW 应该在其他地方也部署有设备，据推测是在省级骨干路由的位置。</p>
<p>对于 GFW 到底在哪这个话题，最近又有国外友人表达了兴趣 <a target="_blank" rel="noopener" href="https://github.com/mothran/mongol">https://github.com/mothran/mongol</a> 。笔者在前人的基础上写了一个更完备的探测工具 <a target="_blank" rel="noopener" href="https://github.com/fqrouter/qiang">https://github.com/fqrouter/qiang</a> 。其原理是基于一个 IP 协议的特性叫 TTL。TTL 是 Time to Live 的简写。IP 包在没经过一次路由的时候，路由器都会把 IP 包的 TTL 减去 1。如果 TTL 到零了，路由器就不会再把 IP 包发给下一级路由。然后我们知道 GFW 会在监听到不和谐的 IP 包之后发回 RST 包来重置 TCP 连接。那么通过设置不同的 TTL 就可以知道从你的电脑，到 GFW 之间经过了几个路由器。比如说 TTL 设置成 9 不触发 RST，但是 10 就触发 RST，那么到 GFW 就是经过了 10 个路由器。另外一个 IP 协议的特性是当 TTL 耗尽的时候，路由器应该发回一个 TTL EXCEEDED 的 ICMP 包，并把自己的 IP 地址设置成 SRC（来源）。结合这两点，就可以探测出 IP 包是到了 IP 地址为什么的路由器之后才被 GFW 检测到。有了 IP 地址之后，再结合 IP 地址地理位置的数据库就可以知道其地理位置。据说，得出的位置大概是这样的：</p>
<p>但是这里检测出来的 IP 到底是 GFW 的还是骨干路由器的？更有可能的是骨干路由器的 IP。GFW 做为一个设备用 “分光” 的方式挂在主干路由器旁边做入侵检测。无论如何，GFW 通过某种神奇的方式，可以拿到你和国外服务器之间来往的所有的 IP 包，这点是肯定的。更严谨的理论研究有：<a target="_blank" rel="noopener" href="https://web.eecs.umich.edu/~zmao/Papers/china-censorship-pam11.pdf">Internet Censorship in China: Where Does the Filtering Occur?</a></p>
<p>GFW 在拥有了这些 IP 包之后，要做一个艰难的决定，那就是到底要不要让你和服务器之间的通信继续下去。GFW 不能太过于激进，毕竟全国性的不能访问国外的网站是违反 GFW 自身存在价值的。GFW 就需要在理解了 IP 包背后代表的含义之后，再来决定是不是可以安全的阻断你和国外服务器之间的连接。这种理解就要建立了前面说的 “重建” 这一步的基础上。大概用图表达一下重建是在怎么一回事：</p>
<p><img src= "/img/friend_404.gif" data-lazy-src="/img/gfw2.png" alt="" /></p>
<p>重建需要做的事情就是把 IP 包 1 中的 GET /inde 和 IP 包 2 中的 x.html H 和 IP 包 3 中的 TTP/1.1 拼到一起变成 GET /index.html HTTP/1.1。拼出来的数据可能是纯文本的，也可能是二进制加密的协议内容。具体是什么是你和服务器之间约定好的。GFW 做为窃听者需要猜测才知道你们俩之间的交谈内容。对于 HTTP 协议就非常容易猜测了，因为 HTTP 的协议是标准化的，而且是未加密的。所以 GFW 可以在重建之后很容易的知道，你使用了 HTTP 协议，访问的是什么网站。</p>
<p>重建这样的字节流有一个难点是如何处理巨大的流量？这个问题在这篇博客 <a target="_blank" rel="noopener" href="https://gfwrev.blogspot.tw/2010/02/gfw.html">https://gfwrev.blogspot.tw/2010/02/gfw.html</a> 中已经讲得很明白了。其原理与网站的负载均衡器一样。对于给定的来源和目标，使用一个 HASH 算法取得一个节点值，然后把所有符合这个来源和目标的流量都往这个节点发。所以在一个节点上就可以重建一个 TCP 会话的单向字节流。</p>
<p>最后为了讨论完整，再提两点。虽然 GFW 的重建发生在旁路上是基于分光来实现的，但并不代表整个 GFW 的所有设备都在旁路。后面会提到有一些 GFW 应对形式必须是把一些 GFW 的设备部署在了主干路由上，比如对 Google 的 HTTPS 的间歇性丢包，也就是 GFW 是要参与部分 IP 的路由工作的。另外一点是，重建是单向的 TCP 流，也就是 GFW 根本不在乎双向的对话内容，它只根据监听到的一个方向的内容然后做判断。但是监听本身是双向的，也就是无论是从国内发到国外，还是从国外发到国内，都会被重建然后加以分析。所以一个 TCP 连接对于 GFW 来说会被重建成两个字节流。具体的证据会在后面谈如何直穿 GFW 中详细讲解。</p>
<h2 id="分析"><a class="markdownIt-Anchor" href="#分析"></a> 分析</h2>
<p>分析是 GFW 在重建出字节流之后要做的第二步。对于重建来说，GFW 主要处理 IP 协议，以及上一层的 TCP 和 UDP 协议就可以了。但是对于分析来说，GFW 就需要理解各种各样的应用层的稀奇古怪的协议了。甚至，我们也可以自己发明新的协议。</p>
<p>总的来说，GFW 做协议分析有两个相似，但是不同的目的。第一个目的是防止不和谐内容的传播，比如说使用 Google 搜索了 “不该” 搜索的关键字。第二个目的是防止使用翻墙工具绕过 GFW 的审查。下面列举一些已知的 GFW 能够处理的协议。</p>
<p>对于 GFW 具体是怎么达到目的一，也就是防止不和谐内容传播的就牵涉到对 HTTP 协议和 DNS 协议等几个协议的明文审查。大体的做法是这样的。</p>
<p><img src= "/img/friend_404.gif" data-lazy-src="/img/gfw3.png" alt="" /></p>
<p>像 HTTP 这样的协议会有非常明显的特征供检测，所以第一步就没什么好说的了。当 GFW 发现了包是 HTTP 的包之后就会按照 HTTP 的协议规则拆包。这个拆包过程是 GFW 按照它对于协议的理解来做的。比如说，从 HTTP 的 GET 请求中取得请求的 URL。然后 GFW 拿到这个请求的 URL 去与关键字做匹配，比如查找 Twitter 是否在请求的 URL 中。为什么有拆包这个过程？首先，拆包之后可以更精确的打击，防止误杀。另外可能预先做拆包，比全文匹配更节省资源。其次，xiaoxia 和 liruqi 同学的 jjproxy 的核心就是基于 GFW 的一个 HTTP 拆包的漏洞，当然这个 bug 已经被修复了。其原理就是 GFW 在拆解 HTTP 包的时候没有处理有多出来的 \r\n 这样的情况，但是你访问的 <a target="_blank" rel="noopener" href="http://google.com">google.com</a> 却可以正确处理额外的 \r\n 的情况。从这个例子中可以证明，GFW 还是先去理解协议，然后才做关键字匹配的。关键字匹配应该就是使用了一些高效的正则表达式算法，没有什么可以讨论的。</p>
<p>HTTP 代理和 SOCKS 代理，这两种明文的代理都可以被 GFW 识别。之前笔者认为 GFW 可以在识别到 HTTP 代理和 SOCKS 代理之后，再拆解其内部的 HTTP 协议的正文。也就是做两次拆包。但是分析发现，HTTP 代理的关键字列表和 HTTP 的关键字列表是不一样的，所以笔者现在认为 HTTP 代理协议和 SOCKS 代理协议是当作单独的协议来处理的，并不是拆出载荷的 HTTP 请求再进行分析的。</p>
<p>目前已知的 GFW 会做的协议分析如下：</p>
<h3 id="dns-查询"><a class="markdownIt-Anchor" href="#dns-查询"></a> DNS 查询</h3>
<p>GFW 可以分析 53 端口的 UDP 协议的 DNS 查询。如果查询的域名匹配关键字则会被 DNS 劫持。可以肯定的是，这个匹配过程使用的是类似正则的机制，而不仅仅是一个黑名单，因为子域名实在太多了。证据是：2012 年 11 月 9 日下午 3 点半开始，防火长城对 Google 的泛域名 .google.com 进行了大面积的污染，所有以 .google.com 结尾的域名均遭到污染而解析错误不能正常访问，其中甚至包括不存在的域名（来源: <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%9F%9F%E5%90%8D%E5%8A%AB%E6%8C%81%EF%BC%89">维基百科</a>）</p>
<p>目前为止 53 端口之外的查询也没有被劫持。但是 TCP 的 DNS 查询已经可以被 TCP RST 切断了，表明了 GFW 具有这样的能力，只是不屑于大规模部署。而且 TCP 查询的关键字比 UDP 劫持的域名要少的多。目前只有 <a target="_blank" rel="noopener" href="http://dl.dropbox.com">dl.dropbox.com</a> 会触发 TCP RST。<br />
相关的研究论文有：<br />
<a target="_blank" rel="noopener" href="https://www.icir.org/vern/papers/hold-on.satin12.pdf">Hold-On: Protecting Against On-Path DNS Poisoning</a><br />
<a target="_blank" rel="noopener" href="https://censorbib.nymity.ch/pdf/Lowe2007a.pdf">The Great DNS Wall of China</a></p>
<h3 id="http-请求"><a class="markdownIt-Anchor" href="#http-请求"></a> HTTP 请求</h3>
<p>GFW 可以识别出 HTTP 协议，并且检查 GET 的 URL 与 HOST。如果匹配了关键字则会触发 TCP RST 阻断。前面提到了 jjproxy 使用的构造特殊的 HTTP GET 请求欺骗 GFW 的做法已经失效，现在 GFW 只要看到 \r\n 就直接 TCP RST 阻断了（来源: <a target="_blank" rel="noopener" href="https://plus.google.com/u/0/108661470402896863593/posts/6U6Q492M3yY">https://plus.google.com/u/0/108661470402896863593/posts/6U6Q492M3yY</a> ）<br />
相关的研究论文有：<br />
<a target="_blank" rel="noopener" href="http://www.internetfreedom.org/files/WhitePaper/ChinaGreatFirewallRevealed.pdf">The Great Firewall Revealed</a><br />
<a target="_blank" rel="noopener" href="https://www.cl.cam.ac.uk/~rnc1/ignoring.pdf">Ignoring the Great Firewall of China</a><br />
<a target="_blank" rel="noopener" href="https://www.researchgate.net/publication/221609631_ConceptDoppler_A_weather_tracker_for_internet_censorship">ConceptDoppler: A Weather Tracker for Internet Censorship</a></p>
<h3 id="对翻墙流量的分析识别"><a class="markdownIt-Anchor" href="#对翻墙流量的分析识别"></a> 对翻墙流量的分析识别</h3>
<p>GFW 的第二个目的是封杀翻墙软件。为了达到这个目的 GFW 采取的手段更加暴力。原因简单，对于 HTTP 协议的封杀如果做不好会影响互联网的正常运作，GFW 与互联网是共生的关系，它不会做威胁自己存在的事情。但是对于 TOR 这样的几乎纯粹是为翻墙而存在的协议，只要检测出来就是格杀勿论的了。GFW 具体是如何封杀各种翻墙协议的，我也不是很清楚，事态仍然在不断更新中。但是举两个例子来证明 GFW 的高超技术。</p>
<p>第一个例子是 GFW 对 TOR 的自动封杀，体现了 GFW 尽最大努力去理解协议本身。根据这篇<a target="_blank" rel="noopener" href="https://blog.torproject.org/blog/knock-knock-knockin-bridges-doors">博客</a>。使用中国的 IP 去连接一个美国的 TOR 网桥，会被 GFW 发现。然后 GFW 回头（15 分钟之后）会亲自假装成客户端，用 TOR 的协议去连接那个网桥。如果确认是 TOR 的网桥，则会封当时的那个端口。换了端口之后，可以用一段时间，然后又会被封。这表现出了 GFW 对于协议的高超检测能力，可以从国际出口的流量中敏锐地发现你连接的 TOR 网桥。据 TOR 的同志说是因为 TOR 协议中的握手过程具有太明显的特征了。另外一点就表现了 GFW 的不辞辛劳，居然会自己伪装成客户端过去连连看。</p>
<p>第二个例子表现了 GFW 根本不在乎加密的流量中的具体内容是不是有敏感词。只要疑似翻墙，特别是提供商业服务给多个翻墙，就会被封杀。根据这个<a target="_blank" rel="noopener" href="https://www.v2ex.com/t/55531">帖子</a>(链接已失效) ， 使用的 ShadowSocks 协议。预先部署密钥，没有明显的握手过程仍然被封。据说是 GFW 已经升级为能够机器识别出哪些加密的流量是疑似翻墙服务的。</p>
<p>关于 GFW 是如何识别与封锁翻墙服务器的，最近写了一篇文章提出我的猜想，大家可以去看看：<a target="_blank" rel="noopener" href="http://fqrouter.tumblr.com/post/45969604783/gfw">http://fqrouter.tumblr.com/post/45969604783/gfw</a> 。</p>
<p>最近发现 GFW 对 OpenVPN 和 SSL 证书已经可以做到准实时的封 IP（端口）。原理应该是离线做的深包分析，然后提取出可疑的 IP 列表，经过人工确认之后封 IP。因为 OpenVPN 有显著的协议的特征，而且基本不用于商业场景所以很容易确认是翻墙服务。但是 SSL 也就是 HTTPS 用的加密协议也能基于 “证书” 做过滤不得不令人感到敬畏了。Shadowsocks 的作者 Clowwindy 为此专门撰文 “为什么不应该用 SSL 翻墙 “：<a target="_blank" rel="noopener" href="https://gist.github.com/clowwindy/5947691">https://gist.github.com/clowwindy/5947691</a> 。</p>
<p>总结起来就是，GFW 已经基本上完成了目的一的所有工作。明文的协议从 HTTP 到 SMTP 都可以分析然后关键字检测，甚至电驴这样不是那么大众的协议 GFW 都去搞了。从原理上来说也没有什么好研究的，就是明文，拆包，关键字。GFW 显然近期的工作重心在分析网络流量上，从中识别出哪些是翻墙的流量。这方面的研究还比较少，而且一个显著的特征是自己用没关系，大规模部署就容易出问题。我目前没有在 GFW 是如何封翻墙工具上有太多研究，只能是道听途说了。</p>
<h2 id="措施"><a class="markdownIt-Anchor" href="#措施"></a> 措施</h2>
<h3 id="封-ip"><a class="markdownIt-Anchor" href="#封-ip"></a> 封 IP</h3>
<p>一般常见于人工检测之后的应对。还没有听说有什么方式可以直接使得 GFW 的机器检测直接封 IP。一般常见的现象是 GFW 机器检测，然后用 TCP RST 重置来应对。过了一段时间才会被封 IP，而且没有明显的时间规律。所以我的推测是，全局性的封 IP 应该是一种需要人工介入的。注意我强调了全局性的封 IP，与之相对的是部分封 IP，比如只对你访问那个 IP 封个 3 分钟，但是别人还是可以访问这样的。这是一种完全不同的封锁方式，虽然现象差不多，都是 ping 也 ping 不通。要观摩的话 ping <a target="_blank" rel="noopener" href="http://twitter.com">twitter.com</a> 就可以了，都封了好久了。</p>
<p>其实现方式是把无效的路由黑洞加入到主干路由器的路由表中，然后让这些主干网上的路由器去帮 GFW 把到指定 IP 的包给丢弃掉。路由器的路由表是动态更新的，使用的协议是 BGP 协议。GFW 只需要维护一个被封的 IP 列表，然后用 BGP 协议广播出去就好了。然后国内主干网上的路由器都好像变成了 GFW 的一份子那样，成为了帮凶。</p>
<p>如果我们使用 traceroute 去检查这种被全局封锁的 IP 就可以发现，IP 包还没有到 GFW 所在的国际出口就已经被电信或者联通的路由器给丢弃了。这就是 BGP 广播的作用了。</p>
<h3 id="dns-劫持"><a class="markdownIt-Anchor" href="#dns-劫持"></a> DNS 劫持</h3>
<p>这也是一种常见的人工检测之后的应对。人工发现一个不和谐网站，然后就把这个网站的域名给加到劫持列表中。其原理是基于 DNS 与 IP 协议的弱点，DNS 与 IP 这两个协议都不验证服务器的权威性，而且 DNS 客户端会盲目地相信第一个收到的答案。所以你去查询 <a target="_blank" rel="noopener" href="http://facebook.com">facebook.com</a> 的话，GFW 只要在正确的答案被返回之前抢答了，然后伪装成你查询的 DNS 服务器向你发错误的答案就可以了。</p>
<h3 id="tcp-rst-阻断"><a class="markdownIt-Anchor" href="#tcp-rst-阻断"></a> TCP RST 阻断</h3>
<p>TCP 协议规定，只要看到 RST 包，连接立马被中断。从浏览器里来看就是连接已经被重置。我想对于这个错误大家都不陌生。据我个人观感，这种封锁方式是 GFW 目前的主要应对手段。大部分的 RST 是条件触发的，比如 URL 中包含某些关键字。目前享受这种待遇的网站就多得去了，著名的有 facebook。还有一些网站，会被无条件 RST。也就是针对特定的 IP 和端口，无论包的内容就会触发 RST。比较著名的例子是 https 的 wikipedia。GFW 在 TCP 层的应对是利用了 IPv4 协议的弱点，也就是只要你在网络上，就假装成任何人发包。所以 GFW 可以很轻易地让你相信 RST 确实是 Google 发的，而让 Google 相信 RST 是你发的。</p>
<h3 id="封端口"><a class="markdownIt-Anchor" href="#封端口"></a> 封端口</h3>
<p>GFW 除了自身主体是挂在骨干路由器旁路上的入侵检测设备，利用分光技术从这个骨干路由器抓包下来做入侵检测 (所谓 IDS)，除此之外这个路由器还会被用来封端口 (所谓 IPS)。GFW 在检测到入侵之后可以不仅仅可以用 TCP RST 阻断当前这个连接，而且利用骨干路由器还可以对指定的 IP 或者端口进行从封端口到封 IP，设置选择性丢包的各种封禁措施。可以理解为骨干路由器上具有了类似 “iptables” 的能力（网络层和传输层的实时拆包，匹配规则的能力）。这个 iptables 的能力在 CISCO 路由器上叫做 ACL Based Forwarding (ABF)。而且规则的部署是全国同步的，一台路由器封了你的端口，全国的挂了 GFW 的骨干路由器都会封。一般这种封端口都是针对翻墙服务器的，如果检测到服务器是用 SSH 或者 VPN 等方式提供翻墙服务。GFW 会在全国的出口骨干路由上部署这样的一条 ACL 规则，来封你这个服务器 + 端口的下行数据包。也就是如果包是从国外发向国内的，而且 src（源 ip）是被封的服务器 ip，sport（源端口）是被封的端口，那么这个包就会被过滤掉。这样部署的规则的特点是，上行的数据包是可以被服务器收到的，而下行的数据包会被过滤掉。</p>
<p>如果被封端口之后服务器采取更换端口的应对措施，很快会再次被封。而且多次尝试之后会被封 IP。初步推断是，封端口不是 GFW 的自动应对行为，而是采取黑名单加人工过滤地方式实现的。一个推断的理由就是网友报道，封端口都是发生在白天工作时间。</p>
<h3 id="反向墙"><a class="markdownIt-Anchor" href="#反向墙"></a> 反向墙</h3>
<p>大部分机场使用的国内中转服务器，GFW 检测到了十分异常的境外大流量，就会在特殊时期，如两会和国庆期间，将该服务器反向墙。具体表现为国外的服务器无法访问该被反向墙了的 IP。测该国内服务器的 ping 就是国外一片红，国内一片绿。解决方法不多，要么更换 IP，或者等敏感时期过去，自动恢复。</p>
<h2 id="翻墙原理"><a class="markdownIt-Anchor" href="#翻墙原理"></a> 翻墙原理</h2>
<p>前面从原理上讲解了 GFW 的运作原理。翻墙的原理与之相对应，分为两大类。第一类是大家普遍的使用的绕道的方式。IP 包经由第三方中转已加密的形式通过 GFW 的检查。这样的一种做法更像 “翻” 墙，是从墙外绕过去的。第二类是找出 GFW 检测过程的中一些 BUG，利用这些 BUG 让 GFW 无法知道准确的会话内容从而放行。</p>
<p>基于绕道法的翻墙方式无论是 VPN 还是 SOCKS 代理，原理都是类似的。都是以国外有一个代理服务器为前提，然后你与代理服务器通信，代理服务器再与目标服务器通信。</p>
<p>除了基本的 http L2TP sock5 等代理协议外，现在主流的翻墙访问境外网站的协议均为 ss,vmess,ssr,vless,trojan,kcp,hysteria 等。</p>
<h3 id="协议直连"><a class="markdownIt-Anchor" href="#协议直连"></a> 协议（直连）</h3>
<h4 id="shadowsocks"><a class="markdownIt-Anchor" href="#shadowsocks"></a> Shadowsocks</h4>
<p>shadowsocks（ss）是一种基于 sock5 代理方式的加密传输协议。初代版本发布于 2012 年 4 月 20 日。Shadowsocks 使用自行设计的协定进行加密通信。加密演算法有 AES、Blowfish、ChaCha20、RC4 等，除建立 TCP 连接外无需握手，每次请求只转发一个连接，无需保持一直连线的状态，因此在流动装置上相对较为省电。</p>
<p><img src= "/img/friend_404.gif" data-lazy-src="/img/gfw4.jpg" alt="" /></p>
<p>现如今的该协议的现状是被 GFW 检测并且可以接着封禁，包括但不限于阻断、封端口、封 IP 等。所以如果是直连 SS 的话，基本就是头铁硬刚了。</p>
<p>因为其低延迟的原因，仍是众多主流机场的选择。（机场都使用中转，并非 ss 直连，所以封禁对其并无影响）</p>
<p><strong>支持软件</strong></p>
<p>其附带的衍生软件，shadowsocks 和 shadowsocksr 已基本被淘汰。</p>
<p>clash/v2rayn/v2rayng/shadowrocket/quantumultx 等主流软件都兼容该协议</p>
<h4 id="shadowsocksr"><a class="markdownIt-Anchor" href="#shadowsocksr"></a> shadowsocksr</h4>
<p>可以说 shadowsocksr（ssr / 酸酸乳）是 ss 的升级版。SSR 是网名为 breakwa11 的用户发起的 Shadowsocks 分支，在 Shadowsocks 的基础上增加了一些资料混淆方式，称修复了部分安全问题并可以提高 QoS 优先级。后来贡献者 Librehat 也为 Shadowsocks 补上了一些此类特性，甚至增加了类似 Tor 的可插拔传输层功能。</p>
<p><strong>支持软件</strong></p>
<p>其附带的衍生软件，shadowsocks 和 shadowsocksr 已基本被淘汰。</p>
<p>clash/v2rayn/v2rayng/shadowrocket/quantumultx 等主流软件都兼容该协议</p>
<h4 id="vmess"><a class="markdownIt-Anchor" href="#vmess"></a> VMess</h4>
<p>VMess 是一个基于 TCP 的加密传输协议，所有数据使用 TCP 传输。它分为入站和出站两部分，通常作为 V2Ray 客户端和服务器之间的桥梁。基于 v2ray 内核。</p>
<p>VMess 依赖于系统时间，请确保使用 V2Ray 的系统 UTC 时间误差在 90 秒之内，时区无关。在 Linux 系统中可以安装 ntp 服务来自动同步系统时间。</p>
<p>因为其加密性，现在也是主流加密协议之一。搭建直连节点时主要使用 <code>vmess + websocket + tls + nginx伪装</code> 协议，这样理论上是最不容易被墙的协议之一。</p>
<p>vmess 协议的主要特点就是严加密，但是随之而来的问题也很明显，握手次数多了，相较于 ss/ssr，延迟自然也是提高了很多。但是其速度方面是比 ss/ssr 要快的（经测试，同服务器 ss 和 vmess+ws 的速度比较得出，YouTube 也有测速比较视频）。</p>
<p><strong>支持软件</strong></p>
<p>其附带的衍生软件，v2rayn/v2rayng 依旧十分常用，现均默认使用 xray-core。</p>
<p>clash/v2rayn/v2rayng/shadowrocket/quantumultx 等主流软件都兼容该协议</p>
<h4 id="vless"><a class="markdownIt-Anchor" href="#vless"></a> Vless</h4>
<p>vless 也可以说是 vmess 的升级版，基于 xray 内核。VLESS 是一个无状态的轻量传输协议，它分为入站和出站两部分，可以作为 V2Ray 客户端和服务器之间的桥梁。与 VMess 不同，VLESS 不依赖于系统时间，认证方式同样为 UUID，但不需要 alterId。</p>
<p>相较于 vmess，vless 的协议速度更快，延迟方面相差不多。</p>
<p><strong>支持软件</strong></p>
<p>vless 需要使用 xray-core 才能运行。</p>
<p>v2rayn/v2rayng/shadowrocket/quantumultx 等主流软件兼容该协议。clash 很遗憾并不支持。</p>
<h4 id="trojan"><a class="markdownIt-Anchor" href="#trojan"></a> trojan</h4>
<p>与 Shadowsocks 相反，Trojan 不使用自定义的加密协议来隐藏自身。相反，使用特征明显的 TLS 协议 (TLS/SSL)，使得流量看起来与正常的 HTTPS 网站相同。TLS 是一个成熟的加密体系，HTTPS 即使用 TLS 承载 HTTP 流量。使用正确配置的加密 TLS 隧道，可以保证传输的</p>
<p>Trojan 不同于 vmess，可以自定是否加上 tls 加密，trojan 是强制使用 tls 加密的。也就是说 trojan 必须需要域名才能搭建。</p>
<p>速度方面，trojan 和 vmess 相差不多。但是 trojan 最大的优点就是对于服务器端的占用很小，十分的轻量，即使低配服务器也能跑的很爽。</p>
<p><strong>支持软件</strong></p>
<p>clash/v2rayn/v2rayng/shadowrocket/quantumultx 等主流软件兼容该协议。</p>
<h4 id="hysteria"><a class="markdownIt-Anchor" href="#hysteria"></a> Hysteria</h4>
<p>Hysteria 是一个功能丰富的，专为恶劣网络环境进行优化的网络工具（双边加速），比如卫星网络、拥挤的公共 Wi-Fi、在中国连接国外服务器等。 基于修改版的 QUIC 协议。</p>
<p>Hysteria 这是一款由 go 编写的非常优秀的 “轻量” 代理程序，它很好的解决了在搭建富强魔法服务器时最大的痛点 —— 线路拉跨。</p>
<p>在魔法咏唱时最难的不是搭建维护，而是在晚高峰时期的交付质量。当三大运营商晚高变成了：奠信、连不通、移不动时，你我都有感触。 虽然是走的 udp 但是提供 obfs，暂时不会被运营商针对性的 QoS (不开 obfs 也不会被 QoS)。</p>
<p>这是最近十分火的新协议。主要优点就是即使线路不佳，也不用中转或者 CF CDN，使用 hysteria 即可拯救。目前来看对于非国内优化线路还是十分友好的。</p>
<p><strong>支持软件</strong></p>
<p>v2rayn/shadowrocket 最新版已支持 hysteria</p>
<h3 id="中转"><a class="markdownIt-Anchor" href="#中转"></a> 中转</h3>
<p>说完了直连，那么再说说中转吧。</p>
<p>中转主要是分为三种，一种就是国内大带宽服务器直接中转。主要优点就是相较于直连，可以更好的符合国内复杂的运营商网络情况。确定也很明显，对于国外被墙的 IP 束手无策，也怕反向墙，而且并非一个国内服务器就能拉得动所有国外服务器。有的国外服务器联通友好的，用电信的服务器去拉，很有可能就会很拉跨。</p>
<p>第二种就是隧道中转，这也是近几年才有的新的中转方式。隧道中转即一个国内服务器一个国外服务器。因为国外服务器一般有 BGP session，对于复杂的网络情况都可以比较好的应对，隧道的国外端到你的节点服务器普遍线路会比较友好。而隧道国外端到国内端又会经过加密，这样虽然也会略微增加延迟，但是可以无视国外机器被墙的情况。但是国内服务器也会怕反向墙。使用隧道的话，基本一个隧道节点就能拉得动大部分的国外服务器。</p>
<p>第三种就是专线中转，也是最昂贵的。一条 G 口专线一个月基本 2.5w+ rmb，不是有钱的机场用不起的。其实专线和隧道比较类似，同样也是分国内端和国外端。专线分为 IEPL 和 IPLC，对于这俩的定义可以参考 <a target="_blank" rel="noopener" href="https://www.cheshirex.com/2005.html">https://www.cheshirex.com/2005.html</a> 。 专线最大的优点，就是延迟低，稳定，不过墙，所以也不用担心节点服务器被墙或者国内反向墙的问题，可以说除了机房的日常维护等特殊情况下，专线是基本永不掉线的。也正是因为这点备受青睐。</p>
<h3 id="自建"><a class="markdownIt-Anchor" href="#自建"></a> 自建</h3>
<p>很多小白想要自己搭建节点，但是发现搭建完了以后不是断流就是接着被墙了。在这里统一推荐，使用 <code>vmess+ws+tls+nginx伪装</code> 或者 <code>vless+ws+tls+nginx伪装</code> 的搭建方式是比较合理的（没有中转的直连情况下）。对于动态 IP 的服务器来说，使用 <code>vmess+ws</code> 即可，保证速度的同时也不会被阻断。对于辣鸡线路的小鸡，可以使用 hysteria。</p>
<h2 id="小结"><a class="markdownIt-Anchor" href="#小结"></a> 小结</h2>
<p>和 GFW 的斗智斗勇还在继续～～～</p>
<blockquote>
<p>转载编辑补充自 <a target="_blank" rel="noopener" href="https://ednovas.xyz/2022/06/25/gfw/">https://ednovas.xyz/2022/06/25/gfw/</a></p>
</blockquote>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/GFW/">GFW</a><a class="post-meta__tags" href="/tags/VPN/">VPN</a><a class="post-meta__tags" href="/tags/%E4%BA%92%E8%81%94%E7%BD%91/">互联网</a></div><div class="post_share"><div class="social-share" data-image="/img/gfw_bg.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/posts/1090495405/"><img class="next-cover" src= "/img/friend_404.gif" data-lazy-src="/img/blog_bg.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">使用 Github webhook 配合宝塔 webhook 自动部署 hexo 博客</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/2411216157/" title="个人使用vpn&quot;翻墙&quot;是否违法？——基于规范性法律文件、案例以及相关计算机技术的分析与讨论"><img class="cover" src= "/img/friend_404.gif" data-lazy-src="/img/fq_bg.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-26</div><div class="title">个人使用vpn&quot;翻墙&quot;是否违法？——基于规范性法律文件、案例以及相关计算机技术的分析与讨论</div></div></a></div><div><a href="/posts/2367abc0/" title="查水表指南"><img class="cover" src= "/img/friend_404.gif" data-lazy-src="https://s2.loli.net/2022/07/23/lHGbCfMrBVJL2wa.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2014-02-22</div><div class="title">查水表指南</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "/img/friend_404.gif" data-lazy-src="/img/81214117_p1.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">吴涛</div><div class="author-info__description">遇到困难摆大烂</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">14</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/wutao-xuemei" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:laozheng@duck.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">投稿请发送至我的邮箱</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#gfw-%E7%9A%84%E5%8E%9F%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text"> GFW 的原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text"> 分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#dns-%E6%9F%A5%E8%AF%A2"><span class="toc-number">2.1.</span> <span class="toc-text"> DNS 查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#http-%E8%AF%B7%E6%B1%82"><span class="toc-number">2.2.</span> <span class="toc-text"> HTTP 请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E7%BF%BB%E5%A2%99%E6%B5%81%E9%87%8F%E7%9A%84%E5%88%86%E6%9E%90%E8%AF%86%E5%88%AB"><span class="toc-number">2.3.</span> <span class="toc-text"> 对翻墙流量的分析识别</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%AA%E6%96%BD"><span class="toc-number">3.</span> <span class="toc-text"> 措施</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%81-ip"><span class="toc-number">3.1.</span> <span class="toc-text"> 封 IP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dns-%E5%8A%AB%E6%8C%81"><span class="toc-number">3.2.</span> <span class="toc-text"> DNS 劫持</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tcp-rst-%E9%98%BB%E6%96%AD"><span class="toc-number">3.3.</span> <span class="toc-text"> TCP RST 阻断</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%81%E7%AB%AF%E5%8F%A3"><span class="toc-number">3.4.</span> <span class="toc-text"> 封端口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E5%A2%99"><span class="toc-number">3.5.</span> <span class="toc-text"> 反向墙</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BF%BB%E5%A2%99%E5%8E%9F%E7%90%86"><span class="toc-number">4.</span> <span class="toc-text"> 翻墙原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%8F%E8%AE%AE%E7%9B%B4%E8%BF%9E"><span class="toc-number">4.1.</span> <span class="toc-text"> 协议（直连）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#shadowsocks"><span class="toc-number">4.1.1.</span> <span class="toc-text"> Shadowsocks</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#shadowsocksr"><span class="toc-number">4.1.2.</span> <span class="toc-text"> shadowsocksr</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vmess"><span class="toc-number">4.1.3.</span> <span class="toc-text"> VMess</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vless"><span class="toc-number">4.1.4.</span> <span class="toc-text"> Vless</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#trojan"><span class="toc-number">4.1.5.</span> <span class="toc-text"> trojan</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#hysteria"><span class="toc-number">4.1.6.</span> <span class="toc-text"> Hysteria</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E8%BD%AC"><span class="toc-number">4.2.</span> <span class="toc-text"> 中转</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%BB%BA"><span class="toc-number">4.3.</span> <span class="toc-text"> 自建</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">5.</span> <span class="toc-text"> 小结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/1335879585/" title="从 GFW 原理到翻墙原理和协议"><img src= "/img/friend_404.gif" data-lazy-src="/img/gfw_bg.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="从 GFW 原理到翻墙原理和协议"/></a><div class="content"><a class="title" href="/posts/1335879585/" title="从 GFW 原理到翻墙原理和协议">从 GFW 原理到翻墙原理和协议</a><time datetime="2022-08-29T07:55:40.000Z" title="发表于 2022-08-29 15:55:40">2022-08-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/1090495405/" title="使用 Github webhook 配合宝塔 webhook 自动部署 hexo 博客"><img src= "/img/friend_404.gif" data-lazy-src="/img/blog_bg.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="使用 Github webhook 配合宝塔 webhook 自动部署 hexo 博客"/></a><div class="content"><a class="title" href="/posts/1090495405/" title="使用 Github webhook 配合宝塔 webhook 自动部署 hexo 博客">使用 Github webhook 配合宝塔 webhook 自动部署 hexo 博客</a><time datetime="2022-08-27T13:47:11.000Z" title="发表于 2022-08-27 21:47:11">2022-08-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/2411216157/" title="个人使用vpn&quot;翻墙&quot;是否违法？——基于规范性法律文件、案例以及相关计算机技术的分析与讨论"><img src= "/img/friend_404.gif" data-lazy-src="/img/fq_bg.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="个人使用vpn&quot;翻墙&quot;是否违法？——基于规范性法律文件、案例以及相关计算机技术的分析与讨论"/></a><div class="content"><a class="title" href="/posts/2411216157/" title="个人使用vpn&quot;翻墙&quot;是否违法？——基于规范性法律文件、案例以及相关计算机技术的分析与讨论">个人使用vpn&quot;翻墙&quot;是否违法？——基于规范性法律文件、案例以及相关计算机技术的分析与讨论</a><time datetime="2022-08-26T11:20:28.000Z" title="发表于 2022-08-26 19:20:28">2022-08-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/30cd3fd0/" title="Linux更改DNS服务器"><img src= "/img/friend_404.gif" data-lazy-src="/img/75659726.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux更改DNS服务器"/></a><div class="content"><a class="title" href="/posts/30cd3fd0/" title="Linux更改DNS服务器">Linux更改DNS服务器</a><time datetime="2022-08-25T15:59:20.000Z" title="发表于 2022-08-25 23:59:20">2022-08-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/af8ae8ee/" title="宝塔面板跳过强制绑定账户"><img src= "/img/friend_404.gif" data-lazy-src="/img/74431885.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="宝塔面板跳过强制绑定账户"/></a><div class="content"><a class="title" href="/posts/af8ae8ee/" title="宝塔面板跳过强制绑定账户">宝塔面板跳过强制绑定账户</a><time datetime="2022-08-19T17:51:22.000Z" title="发表于 2022-08-20 01:51:22">2022-08-20</time></div></div></div></div></div></div></main><footer id="footer" style="background: rgb(255,255,255,0)"><div id="footer-wrap"><div class="copyright">&copy;2022 By 吴涛</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>